<!DOCTYPE html>
<html>
<head>
    <title>處理登入中...</title>
    <script>
        function handleAuth() {
            try {
                const hash = window.location.hash.substring(1);
                if (!hash) {
                    window.close();
                    return;
                }

                const params = new URLSearchParams(hash);
                const token = params.get('access_token');
                const state = params.get('state');
                const savedState = localStorage.getItem('oauth_state');

                // 基本驗證
                if (state && savedState !== state) {
                    console.error('State 驗證失敗');
                    window.close();
                    return;
                }

                // 傳回 token 給父窗口
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'oauth-callback',
                        accessToken: token,
                        state: state
                    }, '*');
                }

                // 嘗試關閉窗口（可能被瀏覽器阻止）
                setTimeout(() => {
                    window.close();
                }, 300);

            } catch (error) {
                console.error('回調處理錯誤:', error);
                window.close();
            }
        }

        // 舊版 iOS 兼容處理
        if (/iPad|iPhone|iPod.*OS [6-8]_/.test(navigator.userAgent)) {
            document.body.innerHTML = '<p>正在完成登入...</p>';
            setTimeout(handleAuth, 500);
        } else {
            window.addEventListener('load', handleAuth);
        }
    </script>
</head>
<body>
    <p>登入完成，請稍候...</p>
</body>
</html>
