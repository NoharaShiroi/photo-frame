<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google ç›¸ç°¿æ•¸ä½ç›¸æ¡†</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://apis.google.com/js/api.js"></script> <!-- åŠ è½½ Google API -->
</head>
<body>

    <!-- ğŸ”¹ æˆæ¬Šç™»å…¥ -->
    <div id="auth-container">
        <h1>Google ç›¸ç°¿ æ•¸ä½ç›¸æ¡†</h1>
        <button id="authorize-btn">ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥</button>
    </div>

    <!-- ğŸ”¹ ç›¸ç°¿é¸æ“‡ -->
    <div id="app-container" style="display: none;">
        <button id="back-to-album-btn" style="display: none;">é¸æ“‡å…¶ä»–ç›¸ç°¿</button>
        <div id="album-selection-container">
            <h2>é¸æ“‡ç›¸ç°¿</h2>
            <select id="album-select" onchange="app.loadPhotos()">
                <option value="all">æ‰€æœ‰ç›¸ç‰‡</option>
                <!-- åŠ¨æ€ç”Ÿæˆçš„ç›¸ç°¿é€‰é¡¹ -->
            </select>
        </div>

        <!-- ğŸ”¹ ç›¸ç‰‡é¡¯ç¤ºå€ -->
        <div id="photo-container" style="display: none;"></div>
    </div>

    <script>
        const app = {
            CLIENT_ID: "1004388657829-mvpott95dsl5bapu40vi2n5li7i7t7d1.apps.googleusercontent.com", // æ›¿æ¢ä¸ºä½ çš„å®¢æˆ·ç«¯ ID
            REDIRECT_URI: "https://noharashiroi.github.io/photo-frame/", // æ›¿æ¢ä¸ºä½ çš„é‡å®šå‘ URI
            SCOPES: "https://www.googleapis.com/auth/photoslibrary.readonly",
            accessToken: sessionStorage.getItem("access_token") || null,
            albumId: null,
            photos: [],
            currentPhotoIndex: 0,
            nextPageToken: null,
            slideshowInterval: null, // å®šæ—¶å™¨çš„å¼•ç”¨
            isPlaying: true, // æ’­æ”¾çŠ¶æ€

            getAccessToken: function() {
                var hashParams = new URLSearchParams(window.location.hash.substring(1));
                if (hashParams.has("access_token")) {
                    this.accessToken = hashParams.get("access_token");
                    sessionStorage.setItem("access_token", this.accessToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                if (this.accessToken) {
                    document.getElementById("auth-container").style.display = "none";
                    document.getElementById("app-container").style.display = "flex";
                    this.fetchAlbums();
                    this.fetchAllPhotos();  // åœ¨æˆæƒåé¢„åŠ è½½æ‰€æœ‰ç…§ç‰‡
                } else {
                    document.getElementById("auth-container").style.display = "flex";
                    document.getElementById("app-container").style.display = "none";
                }
            },

            authorizeUser: function() {
                var authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${this.CLIENT_ID}&redirect_uri=${encodeURIComponent(this.REDIRECT_URI)}&response_type=token&scope=${this.SCOPES}&prompt=consent`;
                window.location.href = authUrl;
            },

            fetchAlbums: function() {
                if (!this.accessToken) return;
                var url = "https://photoslibrary.googleapis.com/v1/albums?pageSize=50";

                fetch(url, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + this.accessToken }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.albums) {
                        this.renderAlbumList(data.albums);
                    }
                })
                .catch(error => {
                    console.error("Error fetching albums:", error);
                });
            },

            renderAlbumList: function(albums) {
                var albumSelect = document.getElementById("album-select");
                albumSelect.innerHTML = '<option value="all">æ‰€æœ‰ç›¸ç‰‡</option>'; // å»æ‰å¤šä½™çš„é€‰é¡¹
                albums.forEach(album => {
                    var option = document.createElement("option");
                    option.value = album.id;
                    option.textContent = album.title;
                    albumSelect.appendChild(option);
                });
            },

            loadPhotos: function() {
                const albumSelect = document.getElementById("album-select");
                this.albumId = albumSelect.value === "all" ? null : albumSelect.value;

                if (this.albumId) {
                    this.fetchPhotos();
                } else {
                    this.fetchAllPhotos(); // åŠ è½½æ‰€æœ‰ç…§ç‰‡
                }
            },

            fetchAllPhotos: function() {
                const url = "https://photoslibrary.googleapis.com/v1/mediaItems:search";
                const body = {
                    pageSize: 50,
                    pageToken: this.nextPageToken || ''
                };

                fetch(url, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + this.accessToken, "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.mediaItems) {
                        this.photos = [...this.photos, ...data.mediaItems];
                        this.nextPageToken = data.nextPageToken;
                        this.renderPhotos();
                    } else {
                        console.error("No mediaItems found in the response.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching photos:", error);
                });
            },

            fetchPhotos: function() {
                var url = "https://photoslibrary.googleapis.com/v1/mediaItems:search";
                var body = {
                    albumId: this.albumId,
                    pageSize: 50
                };

                fetch(url, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + this.accessToken, "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.mediaItems) {
                        this.photos = data.mediaItems;
                        this.renderPhotos();
                    } else {
                        console.error("No mediaItems found in the response.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching photos:", error);
                });
            },

            renderPhotos: function() {
                var photoContainer = document.getElementById("photo-container");
                photoContainer.innerHTML = '';  // æ¸…ç©ºç…§ç‰‡å®¹å™¨

                if (this.photos.length === 0) {
                    photoContainer.innerHTML = "<p>æ­¤ç›¸ç°¿æ²’æœ‰ç…§ç‰‡</p>";
                } else {
                    this.startSlideshow(); // å¼€å§‹å¹»ç¯ç‰‡æ’­æ”¾
                }

                photoContainer.style.display = "grid";
                document.getElementById("app-container").style.display = "flex"; // æ˜¾ç¤ºç›¸ç‰‡å®¹å™¨
            },

            startSlideshow: function() {
                if (this.photos.length > 0) {
                    this.currentPhotoIndex = 0; // ä»ç¬¬ä¸€å¼ å¼€å§‹å¾ªç¯
                    document.body.requestFullscreen(); // è¿›å…¥å…¨å±æ¨¡å¼
                    this.showCurrentPhoto();
                    this.autoChangePhoto();
                }
            },

            showCurrentPhoto: function() {
                var photoElement = document.createElement("img");
                photoElement.src = `${this.photos[this.currentPhotoIndex].baseUrl}=w1200-h800`;
                photoElement.style.position = "fixed";
                photoElement.style.top = "0";
                photoElement.style.left = "0";
                photoElement.style.width = "100%";
                photoElement.style.height = "100%";
                photoElement.style.objectFit = "cover"; // ä¿æŒæ¯”ä¾‹å¡«å……
                document.body.innerHTML = ""; // æ¸…ç©ºå†…å®¹
                document.body.appendChild(photoElement);
                this.addGestureControls();
            },

            autoChangePhoto: function() {
                this.slideshowInterval = setInterval(() => {
                    this.currentPhotoIndex = (this.currentPhotoIndex + 1) % this.photos.length;
                    this.showCurrentPhoto();
                }, 5000); // æ¯5ç§’è‡ªåŠ¨åˆ‡æ¢ç…§ç‰‡
            },

            addGestureControls: function() {
                let touchStartX = 0;
                let touchEndX = 0;

                // å¤„ç†è§¦æ‘¸å¼€å§‹äº‹ä»¶
                document.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX; // è®°å½•èµ·å§‹è§¦æ‘¸ä½ç½®
                });

                // å¤„ç†è§¦æ‘¸ç»“æŸäº‹ä»¶
                document.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].clientX; // è®°å½•ç»“æŸè§¦æ‘¸ä½ç½®

                    // è®¡ç®—æ»‘åŠ¨æ–¹å‘
                    if (touchEndX < touchStartX - 50) {
                        // å‘å·¦æ»‘åŠ¨ï¼Œå‰å¾€ä¸‹ä¸€å¼ ç…§ç‰‡
                        this.currentPhotoIndex = (this.currentPhotoIndex + 1) % this.photos.length;
                        this.showCurrentPhoto(); // æ›´æ–°æ˜¾ç¤ºçš„ç…§ç‰‡
                    } else if (touchEndX > touchStartX + 50) {
                        // å‘å³æ»‘åŠ¨ï¼Œè¿”å›ä¸Šä¸€å¼ ç…§ç‰‡
                        this.currentPhotoIndex = (this.currentPhotoIndex - 1 + this.photos.length) % this.photos.length;
                        this.showCurrentPhoto(); // æ›´æ–°æ˜¾ç¤ºçš„ç…§ç‰‡
                    }
                });

                // åŒå‡»äº‹ä»¶æ§åˆ¶
                document.addEventListener('dblclick', () => {
                    this.toggleSlideshow();
                });
            },

            toggleSlideshow: function() {
                if (this.isPlaying) {
                    clearInterval(this.slideshowInterval); // æ¸…é™¤è‡ªåŠ¨æ’­æ”¾
                } else {
                    this.autoChangePhoto(); // æ¢å¤è‡ªåŠ¨æ’­æ”¾
                }
                this.isPlaying = !this.isPlaying; // åˆ‡æ¢çŠ¶æ€
            }

        };

        // äº‹ä»¶ç›‘å¬
        document.getElementById("authorize-btn").onclick = app.authorizeUser.bind(app);

        document.getElementById("back-to-album-btn").onclick = () => {
            document.getElementById("photo-container").style.display = "none";
            document.getElementById("album-selection-container").style.display = "block";
        };

        document.addEventListener("DOMContentLoaded", () => app.getAccessToken());

        // æ»šåŠ¨äº‹ä»¶ï¼Œç”¨äºåŠ è½½æ›´å¤šç…§ç‰‡
        window.onscroll = function() {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                app.fetchAllPhotos();
            }
        };
    </script>
</body>
</html>
